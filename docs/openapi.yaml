openapi: 3.0.3
info:
  title: rust-ticket-seckill API
  version: 0.1.0
  description: |
    Minimal ticket seckill system (planned contract).
servers:
  - url: http://localhost:8080

tags:
  - name: Activities
  - name: TicketTypes
  - name: Orders
  - name: Payments

paths:
  /api/health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }

  /api/activities:
    get:
      tags: [Activities]
      summary: List activities
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Activity' }
    post:
      tags: [Activities]
      summary: Create activity
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateActivityRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Activity' }

  /api/activities/{activityId}/ticket-types:
    get:
      tags: [TicketTypes]
      summary: List ticket types for an activity
      parameters:
        - in: path
          name: activityId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/TicketTypeWithInventory' }
    post:
      tags: [TicketTypes]
      summary: Create a ticket type for an activity
      parameters:
        - in: path
          name: activityId
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateTicketTypeRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TicketTypeWithInventory' }

  /api/orders:
    post:
      tags: [Orders]
      summary: Create order (seckill)
      description: |
        Use Idempotency-Key header to make retries safe.
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateOrderRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Order' }
        '409':
          description: Conflict / out of stock
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/orders/{orderId}:
    get:
      tags: [Orders]
      summary: Get order
      parameters:
        - in: path
          name: orderId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Order' }

  /api/payments/simulate:
    post:
      tags: [Payments]
      summary: Simulate payment (dev only)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SimulatePaymentRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }

components:
  schemas:
    Activity:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }
        status: { type: string, enum: [draft, published, closed] }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    CreateActivityRequest:
      type: object
      required: [name, starts_at, ends_at]
      properties:
        name: { type: string }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }

    TicketTypeWithInventory:
      type: object
      properties:
        id: { type: string, format: uuid }
        activity_id: { type: string, format: uuid }
        name: { type: string }
        price_cents: { type: integer }
        per_user_limit: { type: integer }
        sale_starts_at: { type: string, format: date-time, nullable: true }
        sale_ends_at: { type: string, format: date-time, nullable: true }
        total: { type: integer }
        available: { type: integer }

    CreateTicketTypeRequest:
      type: object
      required: [name, price_cents, total]
      properties:
        name: { type: string }
        price_cents: { type: integer }
        total: { type: integer }
        per_user_limit: { type: integer, default: 1 }
        sale_starts_at: { type: string, format: date-time, nullable: true }
        sale_ends_at: { type: string, format: date-time, nullable: true }

    Order:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string }
        activity_id: { type: string, format: uuid }
        ticket_type_id: { type: string, format: uuid }
        qty: { type: integer }
        amount_cents: { type: integer }
        status: { type: string, enum: [pending, paid, cancelled, expired] }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    CreateOrderRequest:
      type: object
      required: [user_id, ticket_type_id, qty]
      properties:
        user_id: { type: string }
        ticket_type_id: { type: string, format: uuid }
        qty: { type: integer, minimum: 1 }

    SimulatePaymentRequest:
      type: object
      required: [order_id]
      properties:
        order_id: { type: string, format: uuid }

    ErrorResponse:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        details: { type: object, additionalProperties: true }
