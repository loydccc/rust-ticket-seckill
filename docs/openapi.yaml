openapi: 3.0.3
info:
  title: ticket-seckill-backend API
  version: 0.1.0
  description: |
    Contract aligned with the current Axum implementation (see backend/src/openapi.rs).
servers:
  - url: http://localhost:8080

tags:
  - name: health
  - name: admin
  - name: seckill
  - name: orders

paths:
  /healthz:
    get:
      tags: [health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/HealthzResponse' }

  /admin/events:
    post:
      tags: [admin]
      summary: Create event
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateEventRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EventDto' }

  /events:
    get:
      tags: [admin]
      summary: List events
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/EventDto' }

  /admin/events/{event_id}/ticket_types:
    post:
      tags: [admin]
      summary: Create ticket type
      parameters:
        - in: path
          name: event_id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateTicketTypeRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TicketTypeDto' }

  /events/{event_id}/ticket_types:
    get:
      tags: [admin]
      summary: List ticket types for an event
      parameters:
        - in: path
          name: event_id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TicketTypeDto' }

  /seckill:
    post:
      tags: [seckill]
      summary: Seckill / purchase (MVP: qty=1)
      parameters:
        - in: header
          name: idempotency-key
          required: false
          schema: { type: string }
          description: Idempotency key (per user). Strongly recommended.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SeckillRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OrderDto' }
        '409':
          description: Out of stock or not in sale window

  /orders/{order_id}:
    get:
      tags: [orders]
      summary: Get order
      parameters:
        - in: path
          name: order_id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OrderDto' }
        '404':
          description: Not found

  /orders/{order_id}/pay:
    post:
      tags: [orders]
      summary: Simulate payment (dev only)
      parameters:
        - in: path
          name: order_id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OrderDto' }
        '404':
          description: Not found
        '409':
          description: Conflict (not payable)

components:
  schemas:
    HealthzResponse:
      type: object
      properties:
        ok: { type: boolean }

    CreateEventRequest:
      type: object
      required: [name, starts_at, ends_at]
      properties:
        name: { type: string }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }

    EventDto:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }

    CreateTicketTypeRequest:
      type: object
      required: [name, price_cents, inventory_total, sale_starts_at, sale_ends_at]
      properties:
        name: { type: string }
        price_cents: { type: integer, format: int64 }
        inventory_total: { type: integer, format: int32 }
        sale_starts_at: { type: string, format: date-time }
        sale_ends_at: { type: string, format: date-time }

    TicketTypeDto:
      type: object
      properties:
        id: { type: string, format: uuid }
        event_id: { type: string, format: uuid }
        name: { type: string }
        price_cents: { type: integer, format: int64 }
        inventory_total: { type: integer, format: int32 }
        inventory_remaining: { type: integer, format: int32 }
        sale_starts_at: { type: string, format: date-time }
        sale_ends_at: { type: string, format: date-time }

    SeckillRequest:
      type: object
      required: [user_id, ticket_type_id, qty]
      properties:
        user_id: { type: string }
        ticket_type_id: { type: string, format: uuid }
        qty: { type: integer, format: int32, enum: [1] }

    OrderDto:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string }
        ticket_type_id: { type: string, format: uuid }
        qty: { type: integer, format: int32 }
        amount_cents: { type: integer, format: int64 }
        status: { type: string, enum: [pending, paid, canceled] }
        created_at: { type: string, format: date-time }
